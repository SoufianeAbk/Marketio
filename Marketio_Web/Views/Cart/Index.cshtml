@model List<Marketio_Shared.DTOs.CartItemDto>
@{
    ViewData["Title"] = "Winkelwagen";
    var cartTotal = ViewBag.CartTotal as decimal? ?? 0;
}

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-cart"></i> Winkelwagen
    </h1>

    <div id="alert-container"></div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            <h4 class="alert-heading">
                <i class="bi bi-cart-x"></i> Uw winkelwagen is leeg
            </h4>
            <p>Begin met winkelen en voeg producten toe aan uw winkelwagen.</p>
            <hr>
            <a asp-controller="Products" asp-action="Index" class="btn btn-primary">
                <i class="bi bi-box-seam"></i> Naar Producten
            </a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body" id="cart-items">
                        @foreach (var item in Model)
                        {
                            <div class="row align-items-center mb-3 pb-3 border-bottom cart-item" data-product-id="@item.ProductId">
                                <div class="col-md-2">
                                    <img src="@item.ImageUrl" alt="@item.ProductName"
                                         class="img-fluid rounded"
                                         onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
                                </div>
                                <div class="col-md-4">
                                    <h5>
                                        <a asp-controller="Products" asp-action="Details" asp-route-id="@item.ProductId"
                                           class="text-decoration-none">
                                            @item.ProductName
                                        </a>
                                    </h5>
                                    <p class="text-muted mb-0">€@item.UnitPrice.ToString("F2")</p>
                                    <small class="text-muted">Voorraad: @item.AvailableStock</small>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group">
                                        <button class="btn btn-outline-secondary btn-decrease" type="button"
                                                data-product-id="@item.ProductId">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" class="form-control text-center quantity-input"
                                               data-product-id="@item.ProductId"
                                               value="@item.Quantity"
                                               min="1" max="@item.AvailableStock">
                                        <button class="btn btn-outline-secondary btn-increase" type="button"
                                                data-product-id="@item.ProductId"
                                                data-max-stock="@item.AvailableStock">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <p class="fw-bold mb-2 item-total">€@item.TotalPrice.ToString("F2")</p>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove"
                                            data-product-id="@item.ProductId"
                                            data-product-name="@item.ProductName">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a asp-controller="Products" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Verder winkelen
                    </a>
                    <form asp-action="ClearCart" method="post" class="d-inline"
                          onsubmit="return confirm('Weet u zeker dat u de winkelwagen wilt legen?');">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Winkelwagen legen
                        </button>
                    </form>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-receipt"></i> Overzicht
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotaal:</span>
                            <span id="cart-subtotal">€@cartTotal.ToString("F2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Verzendkosten:</span>
                            <span class="text-success">Gratis</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Totaal:</strong>
                            <strong class="text-primary" id="cart-total">€@cartTotal.ToString("F2")</strong>
                        </div>

                        <a asp-action="Checkout" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-cart-check"></i> Afrekenen
                        </a>
                        <p class="text-muted small text-center mb-0">
                            <i class="bi bi-shield-check"></i> Veilig betalen
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const token = '@Html.AntiForgeryToken()'.match(/value="([^"]+)"/)?.[1];

            // Increase Quantity
            document.querySelectorAll('.btn-increase').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const productId = this.dataset.productId;
                    const maxStock = parseInt(this.dataset.maxStock);
                    const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const currentQty = parseInt(input.value);

                    if (currentQty < maxStock) {
                        await updateQuantity(productId, currentQty + 1);
                    } else {
                        showAlert('Maximale voorraad bereikt', 'warning');
                    }
                });
            });

            // Decrease Quantity
            document.querySelectorAll('.btn-decrease').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const productId = this.dataset.productId;
                    const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const currentQty = parseInt(input.value);

                    if (currentQty > 1) {
                        await updateQuantity(productId, currentQty - 1);
                    }
                });
            });

            // Manual Input Change
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', async function() {
                    const productId = this.dataset.productId;
                    const newQty = parseInt(this.value);

                    if (newQty >= 1) {
                        await updateQuantity(productId, newQty);
                    }
                });
            });

            // Remove Item
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!confirm('Weet u zeker dat u dit product wilt verwijderen?')) return;

                    const productId = this.dataset.productId;
                    const productName = this.dataset.productName;

                    try {
                        const response = await fetch('@Url.Action("RemoveItem", "Cart")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: `productId=${productId}&__RequestVerificationToken=${encodeURIComponent(token)}`
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Remove item from DOM
                            const itemElement = document.querySelector(`.cart-item[data-product-id="${productId}"]`);
                            itemElement.style.transition = 'opacity 0.3s';
                            itemElement.style.opacity = '0';
                            setTimeout(() => itemElement.remove(), 300);

                            // Update totals
                            updateCartTotals(result.cartTotal, result.cartCount);

                            showAlert(`${productName} verwijderd uit winkelwagen`, 'success');

                            // Reload if cart is empty
                            if (result.cartCount === 0) {
                                setTimeout(() => location.reload(), 1500);
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showAlert('Fout bij verwijderen van product', 'danger');
                    }
                });
            });

            // Update Quantity Function
            async function updateQuantity(productId, quantity) {
                try {
                    const response = await fetch('@Url.Action("UpdateQuantity", "Cart")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId, quantity })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Update input value
                        const input = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                        input.value = quantity;

                        // Update item total
                        const itemTotal = document.querySelector(`.cart-item[data-product-id="${productId}"] .item-total`);
                        itemTotal.textContent = `€${result.itemTotal.toFixed(2)}`;

                        // Update cart totals
                        updateCartTotals(result.cartTotal, result.cartCount);
                    } else {
                        showAlert(result.message || 'Fout bij bijwerken', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showAlert('Fout bij bijwerken van aantal', 'danger');
                }
            }

            // Update Cart Totals
            function updateCartTotals(total, count) {
                document.getElementById('cart-subtotal').textContent = `€${total.toFixed(2)}`;
                document.getElementById('cart-total').textContent = `€${total.toFixed(2)}`;

                // Update cart badge in header
                const cartBadge = document.getElementById('cart-count');
                if (cartBadge) {
                    cartBadge.textContent = count;
                    cartBadge.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }

            // ✅ Toon Alert
            function showAlert(message, type) {
                const alertContainer = document.getElementById('alert-container');
                const alert = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill"></i> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                alertContainer.innerHTML = alert;
                setTimeout(() => $('.alert').fadeOut('slow'), 3000);
            }
        });
    </script>
}